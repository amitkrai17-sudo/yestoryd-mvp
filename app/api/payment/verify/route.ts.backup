// file: app/api/payment/verify/route.ts
// Payment verification with revenue split calculation
// Updated: Integrates with revenue split system

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import crypto from 'crypto';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

// Verify Razorpay signature
function verifyPaymentSignature(
  orderId: string,
  paymentId: string,
  signature: string
): boolean {
  const secret = process.env.RAZORPAY_KEY_SECRET!;
  const generatedSignature = crypto
    .createHmac('sha256', secret)
    .update(`${orderId}|${paymentId}`)
    .digest('hex');
  return generatedSignature === signature;
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    const {
      razorpay_order_id,
      razorpay_payment_id,
      razorpay_signature,
      // Child & Parent data
      childId,
      childName,
      childAge,
      parentName,
      parentEmail,
      parentPhone,
      // Coach & Package data
      coachId,
      packageType,
      amount,
      // Source tracking for revenue split
      leadSource,           // 'yestoryd' | 'coach'
      leadSourceCoachId,    // If coach sourced the lead
      // Preferences
      preferredDay,
      preferredTime,
      source,
    } = body;

    // ==================== STEP 1: VERIFY SIGNATURE ====================
    if (!verifyPaymentSignature(razorpay_order_id, razorpay_payment_id, razorpay_signature)) {
      console.error('❌ Invalid payment signature');
      return NextResponse.json(
        { success: false, error: 'Invalid payment signature' },
        { status: 400 }
      );
    }

    console.log('✅ Payment signature verified:', razorpay_payment_id);

    // ==================== STEP 2: GET OR CREATE PARENT ====================
    let parentId: string;
    
    const { data: existingParent } = await supabase
      .from('parents')
      .select('id')
      .eq('email', parentEmail)
      .maybeSingle();

    if (existingParent) {
      parentId = existingParent.id;
      console.log('✅ Existing parent found:', parentId);
    } else {
      const { data: newParent, error: parentError } = await supabase
        .from('parents')
        .insert({
          name: parentName,
          email: parentEmail,
          phone: parentPhone,
        })
        .select('id')
        .single();

      if (parentError) {
        console.error('❌ Parent creation error:', parentError);
        throw new Error('Failed to create parent record');
      }
      parentId = newParent.id;
      console.log('✅ New parent created:', parentId);
    }

    // ==================== STEP 3: GET OR CREATE CHILD ====================
    let finalChildId = childId;
    
    // Check if childId is a valid UUID
    const isValidUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(childId);
    
    if (!isValidUUID || !childId) {
      // Create new child record
      const { data: newChild, error: childError } = await supabase
        .from('children')
        .insert({
          name: childName,
          age: parseInt(childAge) || 6,
          parent_id: parentId,
          parent_email: parentEmail,
          parent_phone: parentPhone,
          parent_name: parentName,
          lead_status: 'enrolled',
        })
        .select('id')
        .single();

      if (childError) {
        console.error('❌ Child creation error:', childError);
        throw new Error('Failed to create child record');
      }
      finalChildId = newChild.id;
      console.log('✅ New child created:', finalChildId);
    } else {
      // Update existing child
      await supabase
        .from('children')
        .update({
          lead_status: 'enrolled',
          parent_id: parentId,
        })
        .eq('id', childId);
      console.log('✅ Existing child updated:', childId);
    }

    // ==================== STEP 4: GET COACH ====================
    let finalCoachId = coachId;
    let coachData = null;

    if (coachId) {
      const { data: coach } = await supabase
        .from('coaches')
        .select('id, name, email, calendar_id')
        .eq('id', coachId)
        .maybeSingle();

      if (coach) {
        finalCoachId = coach.id;
        coachData = coach;
      }
    }

    // If no coach assigned, get default (Rucha)
    if (!finalCoachId) {
      const { data: defaultCoach } = await supabase
        .from('coaches')
        .select('id, name, email, calendar_id')
        .eq('email', 'rucha@yestoryd.com')
        .maybeSingle();

      if (defaultCoach) {
        finalCoachId = defaultCoach.id;
        coachData = defaultCoach;
      }
    }

    console.log('✅ Coach:', coachData?.name || 'Default');

    // Assign coach to child
    await supabase
      .from('children')
      .update({ 
        coach_id: finalCoachId,
        assigned_to: coachData?.email || 'rucha@yestoryd.com',
      })
      .eq('id', finalChildId);

    // ==================== STEP 5: CREATE PAYMENT RECORD ====================
    const paymentAmount = amount || 5999;

    const { data: payment, error: paymentError } = await supabase
      .from('payments')
      .insert({
        child_id: finalChildId,
        coach_id: coachData?.name || 'rucha', // text field for coach name
        razorpay_order_id: razorpay_order_id,
        razorpay_payment_id: razorpay_payment_id,
        amount: paymentAmount,
        package_type: packageType || 'coaching-3month',
        source: source || 'website',
        status: 'captured',
        captured_at: new Date().toISOString(),
      })
      .select('id')
      .single();

    if (paymentError) {
      console.error('⚠️ Payment record error:', paymentError);
    } else {
      console.log('✅ Payment recorded:', payment?.id);
    }

    // ==================== STEP 6: CREATE ENROLLMENT ====================
    const programStart = new Date();
    const programEnd = new Date();
    programEnd.setMonth(programEnd.getMonth() + 3);

    const { data: enrollment, error: enrollmentError } = await supabase
      .from('enrollments')
      .insert({
        child_id: finalChildId,
        parent_id: parentId,
        coach_id: finalCoachId,
        payment_id: razorpay_payment_id,
        amount: paymentAmount,
        status: 'active',
        program_start: programStart.toISOString(),
        program_end: programEnd.toISOString(),
        preferred_day: preferredDay,
        preferred_time: preferredTime,
        schedule_confirmed: false,
      })
      .select('id')
      .single();

    if (enrollmentError) {
      console.error('⚠️ Enrollment error:', enrollmentError);
    } else {
      console.log('✅ Enrollment created:', enrollment?.id);
    }

    // ==================== STEP 7: CALCULATE REVENUE SPLIT ====================
    if (enrollment?.id && finalCoachId) {
      try {
        // Determine lead source (default to 'yestoryd' if not specified)
        const finalLeadSource = leadSource || 'yestoryd';
        
        const revenueResponse = await fetch(
          `${process.env.NEXT_PUBLIC_APP_URL || 'https://yestoryd.com'}/api/enrollment/calculate-revenue`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              enrollment_id: enrollment.id,
              total_amount: paymentAmount,
              lead_source: finalLeadSource,
              lead_source_coach_id: finalLeadSource === 'coach' ? leadSourceCoachId : null,
              coaching_coach_id: finalCoachId,
              child_id: finalChildId,
              child_name: childName,
            }),
          }
        );

        const revenueData = await revenueResponse.json();
        
        if (revenueData.success) {
          console.log('✅ Revenue split calculated:', {
            lead_cost: revenueData.breakdown?.lead_cost?.amount,
            coach_cost: revenueData.breakdown?.coach_cost?.amount,
            platform_fee: revenueData.breakdown?.platform_fee?.amount,
            payouts_scheduled: revenueData.payouts_scheduled?.length,
          });
        } else {
          console.error('⚠️ Revenue calculation failed:', revenueData.error);
        }
      } catch (revenueError) {
        console.error('⚠️ Revenue calculation error:', revenueError);
        // Don't fail the payment - revenue can be calculated later
      }
    }

    // ==================== STEP 8: SCHEDULE SESSIONS ====================
    if (enrollment?.id && finalCoachId) {
      try {
        const scheduleResponse = await fetch(
          `${process.env.NEXT_PUBLIC_APP_URL || 'https://yestoryd.com'}/api/sessions/schedule`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              enrollmentId: enrollment.id,
              childId: finalChildId,
              childName: childName,
              parentEmail: parentEmail,
              coachId: finalCoachId,
              preferredDay: preferredDay,
              preferredTime: preferredTime,
            }),
          }
        );

        const scheduleData = await scheduleResponse.json();
        
        if (scheduleData.success) {
          console.log('✅ Sessions scheduled:', scheduleData.sessionsCreated || 9);
        } else {
          console.error('⚠️ Session scheduling failed:', scheduleData.error);
        }
      } catch (scheduleError) {
        console.error('⚠️ Session scheduling error:', scheduleError);
        // Don't fail - sessions can be scheduled later
      }
    }

    // ==================== STEP 9: SEND CONFIRMATION EMAIL ====================
    try {
      await fetch(
        `${process.env.NEXT_PUBLIC_APP_URL || 'https://yestoryd.com'}/api/email/enrollment-confirmation`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            parentEmail,
            parentName,
            childName,
            coachName: coachData?.name || 'Rucha Rai',
            amount: paymentAmount,
            paymentId: razorpay_payment_id,
          }),
        }
      );
      console.log('✅ Confirmation email triggered');
    } catch (emailError) {
      console.error('⚠️ Email error:', emailError);
    }

    // ==================== STEP 10: RETURN SUCCESS ====================
    return NextResponse.json({
      success: true,
      message: 'Payment verified and enrollment completed',
      data: {
        enrollmentId: enrollment?.id,
        childId: finalChildId,
        parentId,
        coachId: finalCoachId,
        paymentId: razorpay_payment_id,
        amount: paymentAmount,
      },
    });

  } catch (error: any) {
    console.error('❌ Payment verification error:', error);
    return NextResponse.json(
      { success: false, error: error.message || 'Payment verification failed' },
      { status: 500 }
    );
  }
}